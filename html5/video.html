﻿<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>@Model.AnimeTitle - @Model.EpisodeTitle - @Model.WebSiteName</title>
    <link rel="shortcut icon" href="css/icon.png" type="image/x-icon">
    <link href="css/bootstrap-5.3.3.min.css" rel="stylesheet">
    <link href="css/font-awesome-all-6.5.2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/DPlayer.min.css">
    <link rel="stylesheet" href="css/video.css?v=@Model.StaticResourceVersion">
    <script src="js/DPlayer-1.27.0.min.js"></script>
    <script src="js/subtitles-octopus.js"></script>
    <style type="text/css">
        @If.UseCustomBackground
        body {
            background: url(@Model.CustomBackgroundUrl);
            background-attachment: fixed;
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
        }
        @EndIf
        @IfNot.UseCustomBackground
        body {
            background: linear-gradient(to bottom, #FFD194, #70E1F5);
        }
        .container {
            background: rgba(255, 255, 255, 0.9);
        }
        @EndIf

        /* 播放进度提示 */
        .progress-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
            max-width: 400px;
            animation: slideInRight 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .progress-alert .btn-close {
            padding: 0.5rem;
        }

        @media (max-width: 768px) {
            .progress-alert {
                top: 10px;
                right: 10px;
                left: 10px;
                min-width: auto;
                max-width: none;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                @Model.AnimeTitle
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                @Model.EpisodeTitle
            </li>
        </ol>
    </nav>

    <!-- 播放进度恢复提示 -->
    <div id="progressAlert" class="alert alert-info alert-dismissible fade show progress-alert" role="alert" style="display: none;">
        <strong><i class="fas fa-clock"></i> 继续播放</strong>
        <div id="progressMessage" style="margin-top: 0.5rem; font-size: 0.9rem;"></div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="关闭"></button>
    </div>

    <div class="player-wrapper">
        <div class="player-main">
            <div id="dplayer"></div>
        </div>

        <div class="player-sidebar">
            @If.HasSubtitle
            <div class="compact-card">
                <div class="compact-card-header" id="subtitleSelector">
                    <div class="current-item-info">
                        <i class="fas fa-closed-captioning"></i>
                        <span class="current-item-text">
                            字幕列表
                        </span>
                    </div>
                    <i class="fas fa-chevron-right expand-icon"></i>
                </div>
                <div class="sidebar-panel-content" id="subtitlePanel">
                    <div class="sidebar-panel-body">
                        <div class="list-group">
                            @Each.SubtitleFiles
                            <a href="video.html?id=@Model.Id&subtitle=@Current.SafeName" class="list-group-item list-group-item-action
                            @If.IsCurrent
                                active
                            @EndIf
                            ">
                                <i class="fas fa-file-alt"></i> @Current.Name
                            </a>
                            @EndEach
                        </div>
                    </div>
                </div>
            </div>
            @EndIf

            <div class="compact-card">
                <div class="compact-card-header" id="episodeSelector">
                    <div class="current-item-info">
                        <i class="fas fa-list"></i>
                        <span class="current-item-text">
                            播放列表
                        </span>
                    </div>
                    <i class="fas fa-chevron-right expand-icon"></i>
                </div>
                <div class="sidebar-panel-content" id="episodePanel">
                    <div class="sidebar-panel-body">
                        <div class="list-group">
                            @Each.VideoFiles
                            <a href="video.html?id=@Current.Id" class="list-group-item list-group-item-action
                            @If.IsCurrent
                            active
                            @EndIf
                            ">
                                <strong>@Current.EpisodeTitle</strong>
                                <small>@Current.FileName</small>
                            </a>
                            @EndEach
                        </div>
                    </div>
                </div>
            </div>

            <div class="compact-card">
                <div class="compact-card-header" id="danmakuSettingsBtn">
                    <div class="current-item-info">
                        <i class="fas fa-palette"></i>
                        <span class="current-item-text">
                            弹幕外观设置
                        </span>
                    </div>
                    <i class="fas fa-chevron-right expand-icon"></i>
                </div>
                <div class="sidebar-panel-content" id="danmakuSettingsPanel">
                    <div class="sidebar-panel-body">
                        <div class="settings-group">
                            <label for="danmakuFontSize">
                                <i class="fas fa-text-height"></i> 字体大小
                            </label>
                            <div class="settings-row">
                                <input type="range" id="danmakuFontSize" min="12" max="60" value="25" 
                                       oninput="updateDanmakuPreview('fontSize', this.value)">
                                <span class="settings-value" id="danmakuFontSizeValue">25</span>
                            </div>
                        </div>

                        <div class="settings-group">
                            <label for="danmakuFontFamily">
                                <i class="fas fa-font"></i> 字体
                            </label>
                            <select id="danmakuFontFamily" onchange="updateDanmakuPreview('fontFamily', this.value)">
                                <option value="'Microsoft YaHei', SimHei, sans-serif">微软雅黑</option>
                                <option value="SimHei, 'Microsoft JhengHei', Arial, Helvetica, sans-serif">黑体</option>
                                <option value="SimSun, serif">宋体</option>
                                <option value="KaiTi, serif">楷体</option>
                                <option value="Arial, Helvetica, sans-serif">Arial</option>
                                <option value="'Courier New', monospace">Courier New</option>
                            </select>
                        </div>

                        <div class="settings-group">
                            <label>
                                <input type="checkbox" id="danmakuBold" onchange="updateDanmakuPreview('bold', this.checked)">
                                <i class="fas fa-bold"></i> 粗体
                            </label>
                        </div>

                        <div class="settings-group">
                            <label for="danmakuSpeed">
                                <i class="fas fa-tachometer-alt"></i> 滚动速度（持续时间/秒）
                            </label>
                            <div class="settings-row">
                                <input type="range" id="danmakuSpeed" min="3" max="20" step="0.5" value="10" 
                                       oninput="updateDanmakuPreview('speed', this.value)">
                                <span class="settings-value" id="danmakuSpeedValue">10</span>
                            </div>
                        </div>

                        <div class="settings-group">
                            <label for="danmakuOpacity">
                                <i class="fas fa-adjust"></i> 不透明度
                            </label>
                            <div class="settings-row">
                                <input type="range" id="danmakuOpacity" min="0.1" max="1" step="0.1" value="1.0" 
                                       oninput="updateDanmakuPreview('opacity', this.value)">
                                <span class="settings-value" id="danmakuOpacityValue">100</span>
                            </div>
                        </div>

                        <div class="settings-group">
                            <label for="danmakuDisplayArea">
                                <i class="fas fa-expand-arrows-alt"></i> 显示区域（%）
                            </label>
                            <div class="settings-row">
                                <input type="range" id="danmakuDisplayArea" min="25" max="100" step="5" value="100" 
                                       oninput="updateDanmakuPreview('displayArea', this.value)">
                                <span class="settings-value" id="danmakuDisplayAreaValue">100</span>
                            </div>
                        </div>

                        <div class="settings-group">
                            <label for="danmakuLineHeight">
                                <i class="fas fa-text-height"></i> 行间距
                            </label>
                            <div class="settings-row">
                                <input type="range" id="danmakuLineHeight" min="0" max="20" step="1" value="0" 
                                       oninput="updateDanmakuPreview('lineHeight', this.value)">
                                <span class="settings-value" id="danmakuLineHeightValue">0</span>
                            </div>
                        </div>

                        <div class="settings-group">
                            <label for="danmakuTextStrokeWidth">
                                <i class="fas fa-border-style"></i> 描边宽度
                            </label>
                            <div class="settings-row">
                                <input type="range" id="danmakuTextStrokeWidth" min="0" max="3" step="0.1" value="0.5" 
                                       oninput="updateDanmakuPreview('textStrokeWidth', this.value)">
                                <span class="settings-value" id="danmakuTextStrokeWidthValue">0.5</span>
                            </div>
                        </div>

                        <div class="settings-group">
                            <label for="danmakuTextStrokeColor">
                                <i class="fas fa-palette"></i> 描边颜色
                            </label>
                            <input type="color" id="danmakuTextStrokeColor" value="#000000" 
                                   onchange="updateDanmakuPreview('textStrokeColor', this.value)">
                        </div>

                        <div class="settings-group">
                            <label for="danmakuTextShadowX">
                                <i class="fas fa-arrows-alt-h"></i> 阴影水平偏移
                            </label>
                            <div class="settings-row">
                                <input type="range" id="danmakuTextShadowX" min="-5" max="5" step="0.5" value="1.0" 
                                       oninput="updateDanmakuPreview('textShadowX', this.value)">
                                <span class="settings-value" id="danmakuTextShadowXValue">1.0</span>
                            </div>
                        </div>

                        <div class="settings-group">
                            <label for="danmakuTextShadowY">
                                <i class="fas fa-arrows-alt-v"></i> 阴影垂直偏移
                            </label>
                            <div class="settings-row">
                                <input type="range" id="danmakuTextShadowY" min="-5" max="5" step="0.5" value="1.0" 
                                       oninput="updateDanmakuPreview('textShadowY', this.value)">
                                <span class="settings-value" id="danmakuTextShadowYValue">1.0</span>
                            </div>
                        </div>

                        <div class="settings-group">
                            <label for="danmakuTextShadowBlur">
                                <i class="fas fa-cloud"></i> 阴影模糊半径
                            </label>
                            <div class="settings-row">
                                <input type="range" id="danmakuTextShadowBlur" min="0" max="10" step="0.5" value="0.5" 
                                       oninput="updateDanmakuPreview('textShadowBlur', this.value)">
                                <span class="settings-value" id="danmakuTextShadowBlurValue">0.5</span>
                            </div>
                        </div>
                    </div>
                    <div class="settings-actions">
                        <button class="btn-danger" id="resetDanmakuBtn">
                            <i class="fas fa-undo"></i> 重置
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <hr/>
    <footer class="footer">
        <p>
            @IfNot.IsAnonymous
            当前用户: @Model.UserName
            <a href="/web1/logout" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-sign-out-alt"></i> 退出登录
            </a> |
            @EndIf
            @Model.ServerInfo
        </p>
    </footer>
</div>


<script src="js/jquery-3.7.1.min.js"></script>
<script src="js/bootstrap.bundle-5.3.3.min.js"></script>
<script src="js/video.js?v=@Model.StaticResourceVersion"></script>
<script>
    // 播放进度保存功能
    // 从URL参数获取视频ID（UUID），如果没有则使用服务端模型提供的ID
    function getVideoId() {
        var urlParams = new URLSearchParams(window.location.search);
        var idFromUrl = urlParams.get('id');
        return idFromUrl || '@Model.Id';
    }
    var videoId = getVideoId(); // 视频UUID作为存储键
    var lastSavedTime = 0; // 上次保存的时间，避免频繁保存
    
    // 保存播放进度
    function savePlayProgress(time) {
        if (time && time > 0) {
            try {
                localStorage.setItem('video_progress_' + videoId, JSON.stringify({
                    time: time,
                    timestamp: Date.now()
                }));
                lastSavedTime = time;
            } catch (e) {
                console.error('保存播放进度失败:', e);
            }
        }
    }
    
    // 格式化时间为"X分X秒"
    function formatTime(seconds) {
        var minutes = Math.floor(seconds / 60);
        var secs = Math.floor(seconds % 60);
        if (minutes > 0) {
            return minutes + '分' + secs + '秒';
        } else {
            return secs + '秒';
        }
    }
    
    // 格式化日期时间
    function formatDateTime(timestamp) {
        var date = new Date(timestamp);
        var now = new Date();
        var diff = now - date;
        
        // 如果是今天
        if (date.toDateString() === now.toDateString()) {
            var hours = date.getHours();
            var minutes = date.getMinutes();
            return '今天 ' + (hours < 10 ? '0' : '') + hours + ':' + (minutes < 10 ? '0' : '') + minutes;
        }
        
        // 如果是昨天
        var yesterday = new Date(now);
        yesterday.setDate(yesterday.getDate() - 1);
        if (date.toDateString() === yesterday.toDateString()) {
            var hours = date.getHours();
            var minutes = date.getMinutes();
            return '昨天 ' + (hours < 10 ? '0' : '') + hours + ':' + (minutes < 10 ? '0' : '') + minutes;
        }
        
        // 如果是一周内
        if (diff < 7 * 24 * 60 * 60 * 1000) {
            var days = Math.floor(diff / (24 * 60 * 60 * 1000));
            return days + '天前';
        }
        
        // 其他情况显示完整日期
        var year = date.getFullYear();
        var month = date.getMonth() + 1;
        var day = date.getDate();
        var hours = date.getHours();
        var minutes = date.getMinutes();
        return year + '-' + (month < 10 ? '0' : '') + month + '-' + (day < 10 ? '0' : '') + day + ' ' + 
               (hours < 10 ? '0' : '') + hours + ':' + (minutes < 10 ? '0' : '') + minutes;
    }
    
    // 获取保存的播放进度（返回包含时间和时间戳的对象）
    function getSavedProgress() {
        try {
            var saved = localStorage.getItem('video_progress_' + videoId);
            if (saved) {
                var progress = JSON.parse(saved);
                // 如果保存的时间超过30天，清除记录
                if (Date.now() - progress.timestamp > 30 * 24 * 60 * 60 * 1000) {
                    localStorage.removeItem('video_progress_' + videoId);
                    return null;
                }
                return {
                    time: progress.time,
                    timestamp: progress.timestamp
                };
            }
        } catch (e) {
            console.error('读取播放进度失败:', e);
        }
        return null;
    }
    
    // 显示播放进度恢复提示
    function showProgressAlert(time, timestamp) {
        var message = '从 <strong>' + formatTime(time) + '</strong> 继续播放';
        if (timestamp) {
            message += '<br><small style="color: #6c757d;">上次播放: ' + formatDateTime(timestamp) + '</small>';
        }
        document.getElementById('progressMessage').innerHTML = message;
        var alert = document.getElementById('progressAlert');
        alert.style.display = 'block';
        
        // 5秒后自动隐藏
        setTimeout(function() {
            if (alert) {
                $(alert).fadeOut(300, function() {
                    alert.style.display = 'none';
                });
            }
        }, 5000);
    }
    
    // 恢复播放进度
    function restorePlayProgress(dp) {
        var savedProgress = getSavedProgress();
        if (savedProgress && savedProgress.time > 5) { // 如果保存的进度大于5秒，才恢复
            // 等待视频元数据加载完成
            dp.on('loadedmetadata', function() {
                var duration = dp.video.duration;
                var savedTime = savedProgress.time;
                // 如果保存的时间接近视频结尾（最后5%），不恢复
                if (savedTime < duration * 0.95) {
                    dp.seek(savedTime);
                    console.log('已恢复播放进度至: ' + Math.floor(savedTime) + ' 秒');
                    // 显示提示信息
                    showProgressAlert(savedTime, savedProgress.timestamp);
                } else {
                    // 如果接近结尾，清除保存的进度
                    localStorage.removeItem('video_progress_' + videoId);
                }
            });
        }
    }

    $(document).ready(function () {
        var dp = new DPlayer({
            container: document.getElementById('dplayer'),
            theme: '@Model.Color',
            loop: false,
            screenshot: true,
            hotkey: true,
            preload: 'none',
            volume: 1,
            mutex: true,
            video: {
                url: '@Model.Video',
                pic: '@Model.Image',
                type: 'auto'
            },
            danmaku: {
                id: '@Model.Id',
                api: 'dplayer/',
                bottom: '15%',
                unlimited: false
            }
        });
        $(".dplayer-video").attr("crossorigin", "use-credentials");

        var options = {
            video: document.getElementsByClassName('dplayer-video')[0],
            subUrl: '@Model.SubtitleAss',
            fonts: ['@Model.SubtitleFont'],
            workerUrl: 'js/subtitles-octopus-worker.js',
            legacyWorkerUrl: 'js/subtitles-octopus-worker-legacy.js'
        };
        var instance = new SubtitlesOctopus(options);
        
        // 恢复播放进度
        restorePlayProgress(dp);
        
        // 监听播放时间更新，每5秒保存一次进度
        dp.on('timeupdate', function() {
            var currentTime = dp.video.currentTime;
            // 每5秒保存一次进度（正常播放或用户跳转时都会触发）
            var timeDiff = Math.abs(currentTime - lastSavedTime);
            if (timeDiff >= 5) {
                savePlayProgress(currentTime);
            }
        });
        
        // 视频播放结束时，清除保存的进度
        dp.on('ended', function() {
            localStorage.removeItem('video_progress_' + videoId);
            console.log('视频播放完成，已清除播放进度');
        });
        
        // 页面关闭前保存进度
        window.addEventListener('beforeunload', function() {
            if (dp && dp.video) {
                var currentTime = dp.video.currentTime;
                if (currentTime > 0) {
                    savePlayProgress(currentTime);
                }
            }
        });
        
        // 页面隐藏时保存进度（移动端切换应用时）
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && dp && dp.video) {
                var currentTime = dp.video.currentTime;
                if (currentTime > 0) {
                    savePlayProgress(currentTime);
                }
            }
        });
    });

    // Toggle sidebar panel
    function toggleSidebarPanel(panelId, headerId) {
        const panel = document.getElementById(panelId);
        const header = document.getElementById(headerId);
        const icon = header.querySelector('.expand-icon');
        
        const isActive = panel.classList.contains('active');
        
        document.querySelectorAll('.sidebar-panel-content').forEach(p => {
            p.classList.remove('active');
        });
        document.querySelectorAll('.compact-card-header').forEach(h => {
            h.classList.remove('active');
            h.querySelector('.expand-icon').classList.remove('expanded');
        });
        
        if (!isActive) {
            panel.classList.add('active');
            header.classList.add('active');
            icon.classList.add('expanded');
        }
    }

    $(document).ready(function() {
        $('#subtitleSelector').on('click', function() {
            toggleSidebarPanel('subtitlePanel', 'subtitleSelector');
        });
        
        $('#episodeSelector').on('click', function() {
            toggleSidebarPanel('episodePanel', 'episodeSelector');
        });
        
        $('#danmakuSettingsBtn').on('click', function() {
            toggleSidebarPanel('danmakuSettingsPanel', 'danmakuSettingsBtn');
        });
        
        $('#resetDanmakuBtn').on('click', function() {
            if (typeof resetDanmakuSettings === 'function') {
                resetDanmakuSettings();
            }
        });
    });
</script>
</body>
</html>