﻿<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>@Model.AnimeTitle - @Model.EpisodeTitle - @Model.WebSiteName</title>
    <link rel="shortcut icon" href="css/icon.png" type="image/x-icon">
    <link href="css/bootstrap-5.3.3.min.css" rel="stylesheet">
    <link href="css/font-awesome-all-6.5.2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/DPlayer.min.css">
    <link rel="stylesheet" href="css/video.css?v=@Model.StaticResourceVersion">
    <script src="js/DPlayer-1.27.0.min.js"></script>
    <script src="js/subtitles-octopus.js"></script>
    <style type="text/css">
        @If.UseCustomBackground
        body {
            background: url(@Model.CustomBackgroundUrl);
            background-attachment: fixed;
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
        }
        @EndIf
        @IfNot.UseCustomBackground
        body {
            background: linear-gradient(to bottom, #FFD194, #70E1F5);
        }
        .container {
            background: rgba(255, 255, 255, 0.9);
        }
        @EndIf
    </style>
</head>
<body>

<div class="container">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                @Model.AnimeTitle
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                @Model.EpisodeTitle
            </li>
        </ol>
    </nav>

    <div class="player-wrapper">
        <div class="player-main">
            <div id="dplayer"></div>
        </div>

        <div class="player-sidebar">
            @If.HasSubtitle
            <div class="compact-card">
                <div class="compact-card-header" id="subtitleSelector">
                    <div class="current-item-info">
                        <i class="fas fa-closed-captioning"></i>
                        <span class="current-item-text">
                            字幕列表
                        </span>
                    </div>
                    <i class="fas fa-chevron-right expand-icon"></i>
                </div>
                <div class="sidebar-panel-content" id="subtitlePanel">
                    <div class="sidebar-panel-body">
                        <div class="list-group">
                            @Each.SubtitleFiles
                            <a href="video.html?id=@Model.Id&subtitle=@Current.SafeName" class="list-group-item list-group-item-action
                            @If.IsCurrent
                                active
                            @EndIf
                            ">
                                <i class="fas fa-file-alt"></i> @Current.Name
                            </a>
                            @EndEach
                        </div>
                    </div>
                </div>
            </div>
            @EndIf

            <div class="compact-card">
                <div class="compact-card-header" id="episodeSelector">
                    <div class="current-item-info">
                        <i class="fas fa-list"></i>
                        <span class="current-item-text">
                            播放列表
                        </span>
                    </div>
                    <i class="fas fa-chevron-right expand-icon"></i>
                </div>
                <div class="sidebar-panel-content" id="episodePanel">
                    <div class="sidebar-panel-body">
                        <div class="list-group">
                            @Each.VideoFiles
                            <a href="video.html?id=@Current.Id" class="list-group-item list-group-item-action
                            @If.IsCurrent
                            active
                            @EndIf
                            ">
                                <strong>@Current.EpisodeTitle</strong>
                                <small>@Current.FileName</small>
                            </a>
                            @EndEach
                        </div>
                    </div>
                </div>
            </div>

            <div class="compact-card">
                <div class="compact-card-header" id="danmakuSettingsBtn">
                    <div class="current-item-info">
                        <i class="fas fa-palette"></i>
                        <span class="current-item-text">
                            弹幕外观设置
                        </span>
                    </div>
                    <i class="fas fa-chevron-right expand-icon"></i>
                </div>
                <div class="sidebar-panel-content" id="danmakuSettingsPanel">
                    <div class="sidebar-panel-body">
                        <div class="settings-group">
                            <label for="danmakuFontSize">
                                <i class="fas fa-text-height"></i> 字体大小
                            </label>
                            <div class="settings-row">
                                <input type="range" id="danmakuFontSize" min="12" max="60" value="25" 
                                       oninput="updateDanmakuPreview('fontSize', this.value)">
                                <span class="settings-value" id="danmakuFontSizeValue">25</span>
                            </div>
                        </div>

                        <div class="settings-group">
                            <label for="danmakuFontFamily">
                                <i class="fas fa-font"></i> 字体
                            </label>
                            <select id="danmakuFontFamily" onchange="updateDanmakuPreview('fontFamily', this.value)">
                                <option value="'Microsoft YaHei', SimHei, sans-serif">微软雅黑</option>
                                <option value="SimHei, 'Microsoft JhengHei', Arial, Helvetica, sans-serif">黑体</option>
                                <option value="SimSun, serif">宋体</option>
                                <option value="KaiTi, serif">楷体</option>
                                <option value="Arial, Helvetica, sans-serif">Arial</option>
                                <option value="'Courier New', monospace">Courier New</option>
                            </select>
                        </div>

                        <div class="settings-group">
                            <label>
                                <input type="checkbox" id="danmakuBold" onchange="updateDanmakuPreview('bold', this.checked)">
                                <i class="fas fa-bold"></i> 粗体
                            </label>
                        </div>

                        <div class="settings-group">
                            <label for="danmakuSpeed">
                                <i class="fas fa-tachometer-alt"></i> 滚动速度（持续时间/秒）
                            </label>
                            <div class="settings-row">
                                <input type="range" id="danmakuSpeed" min="3" max="20" step="0.5" value="10" 
                                       oninput="updateDanmakuPreview('speed', this.value)">
                                <span class="settings-value" id="danmakuSpeedValue">10</span>
                            </div>
                        </div>

                        <div class="settings-group">
                            <label for="danmakuOpacity">
                                <i class="fas fa-adjust"></i> 不透明度
                            </label>
                            <div class="settings-row">
                                <input type="range" id="danmakuOpacity" min="0.1" max="1" step="0.1" value="1.0" 
                                       oninput="updateDanmakuPreview('opacity', this.value)">
                                <span class="settings-value" id="danmakuOpacityValue">100</span>
                            </div>
                        </div>

                        <div class="settings-group">
                            <label for="danmakuDisplayArea">
                                <i class="fas fa-expand-arrows-alt"></i> 显示区域（%）
                            </label>
                            <div class="settings-row">
                                <input type="range" id="danmakuDisplayArea" min="25" max="100" step="5" value="100" 
                                       oninput="updateDanmakuPreview('displayArea', this.value)">
                                <span class="settings-value" id="danmakuDisplayAreaValue">100</span>
                            </div>
                        </div>

                        <div class="settings-group">
                            <label for="danmakuLineHeight">
                                <i class="fas fa-text-height"></i> 行间距
                            </label>
                            <div class="settings-row">
                                <input type="range" id="danmakuLineHeight" min="0" max="20" step="1" value="0" 
                                       oninput="updateDanmakuPreview('lineHeight', this.value)">
                                <span class="settings-value" id="danmakuLineHeightValue">0</span>
                            </div>
                        </div>

                        <div class="settings-group">
                            <label for="danmakuTextStrokeWidth">
                                <i class="fas fa-border-style"></i> 描边宽度
                            </label>
                            <div class="settings-row">
                                <input type="range" id="danmakuTextStrokeWidth" min="0" max="3" step="0.1" value="0.5" 
                                       oninput="updateDanmakuPreview('textStrokeWidth', this.value)">
                                <span class="settings-value" id="danmakuTextStrokeWidthValue">0.5</span>
                            </div>
                        </div>

                        <div class="settings-group">
                            <label for="danmakuTextStrokeColor">
                                <i class="fas fa-palette"></i> 描边颜色
                            </label>
                            <input type="color" id="danmakuTextStrokeColor" value="#000000" 
                                   onchange="updateDanmakuPreview('textStrokeColor', this.value)">
                        </div>

                        <div class="settings-group">
                            <label for="danmakuTextShadowX">
                                <i class="fas fa-arrows-alt-h"></i> 阴影水平偏移
                            </label>
                            <div class="settings-row">
                                <input type="range" id="danmakuTextShadowX" min="-5" max="5" step="0.5" value="1.0" 
                                       oninput="updateDanmakuPreview('textShadowX', this.value)">
                                <span class="settings-value" id="danmakuTextShadowXValue">1.0</span>
                            </div>
                        </div>

                        <div class="settings-group">
                            <label for="danmakuTextShadowY">
                                <i class="fas fa-arrows-alt-v"></i> 阴影垂直偏移
                            </label>
                            <div class="settings-row">
                                <input type="range" id="danmakuTextShadowY" min="-5" max="5" step="0.5" value="1.0" 
                                       oninput="updateDanmakuPreview('textShadowY', this.value)">
                                <span class="settings-value" id="danmakuTextShadowYValue">1.0</span>
                            </div>
                        </div>

                        <div class="settings-group">
                            <label for="danmakuTextShadowBlur">
                                <i class="fas fa-cloud"></i> 阴影模糊半径
                            </label>
                            <div class="settings-row">
                                <input type="range" id="danmakuTextShadowBlur" min="0" max="10" step="0.5" value="0.5" 
                                       oninput="updateDanmakuPreview('textShadowBlur', this.value)">
                                <span class="settings-value" id="danmakuTextShadowBlurValue">0.5</span>
                            </div>
                        </div>
                    </div>
                    <div class="settings-actions">
                        <button class="btn-danger" id="resetDanmakuBtn">
                            <i class="fas fa-undo"></i> 重置
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <hr/>
    <footer class="footer">
        <p>
            @IfNot.IsAnonymous
            当前用户: @Model.UserName
            <a href="/web1/logout" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-sign-out-alt"></i> 退出登录
            </a> |
            @EndIf
            @Model.ServerInfo
        </p>
    </footer>
</div>


<script src="js/jquery-3.7.1.min.js"></script>
<script src="js/bootstrap.bundle-5.3.3.min.js"></script>
<script src="js/video.js?v=@Model.StaticResourceVersion"></script>
<script>
    $(document).ready(function () {
        var dp = new DPlayer({
            container: document.getElementById('dplayer'),
            theme: '@Model.Color',
            loop: false,
            screenshot: true,
            hotkey: true,
            preload: 'none',
            volume: 1,
            mutex: true,
            video: {
                url: '@Model.Video',
                pic: '@Model.Image',
                type: 'auto'
            },
            danmaku: {
                id: '@Model.Id',
                api: 'dplayer/',
                bottom: '15%',
                unlimited: false
            }
        });
        $(".dplayer-video").attr("crossorigin", "use-credentials");

        var options = {
            video: document.getElementsByClassName('dplayer-video')[0],
            subUrl: '@Model.SubtitleAss',
            fonts: ['@Model.SubtitleFont'],
            workerUrl: 'js/subtitles-octopus-worker.js',
            legacyWorkerUrl: 'js/subtitles-octopus-worker-legacy.js'
        };
        var instance = new SubtitlesOctopus(options);
    });

    // Toggle sidebar panel
    function toggleSidebarPanel(panelId, headerId) {
        const panel = document.getElementById(panelId);
        const header = document.getElementById(headerId);
        const icon = header.querySelector('.expand-icon');
        
        const isActive = panel.classList.contains('active');
        
        document.querySelectorAll('.sidebar-panel-content').forEach(p => {
            p.classList.remove('active');
        });
        document.querySelectorAll('.compact-card-header').forEach(h => {
            h.classList.remove('active');
            h.querySelector('.expand-icon').classList.remove('expanded');
        });
        
        if (!isActive) {
            panel.classList.add('active');
            header.classList.add('active');
            icon.classList.add('expanded');
        }
    }

    $(document).ready(function() {
        $('#subtitleSelector').on('click', function() {
            toggleSidebarPanel('subtitlePanel', 'subtitleSelector');
        });
        
        $('#episodeSelector').on('click', function() {
            toggleSidebarPanel('episodePanel', 'episodeSelector');
        });
        
        $('#danmakuSettingsBtn').on('click', function() {
            toggleSidebarPanel('danmakuSettingsPanel', 'danmakuSettingsBtn');
        });
        
        $('#resetDanmakuBtn').on('click', function() {
            if (typeof resetDanmakuSettings === 'function') {
                resetDanmakuSettings();
            }
        });
    });
</script>
</body>
</html>